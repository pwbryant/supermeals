<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width">
	<title>Javascript Tests</title>
	<link rel="stylesheet" href="https://code.jquery.com/qunit/qunit-2.4.1.css">
	<script src="https://code.jquery.com/qunit/qunit-2.4.1.js"></script>
	<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
	<script src="../d3/d3.min.js"></script>
	<script src="../meal_maker.js"></script>
	<script>
		//helper functions
		var insert_macro_val_trigger_keyup_return_output = function(cals,input_id,val,test_id) {
			$('#id_goal_meal_cals').val('');
			$('#id_goal_meal_cals').val(cals);
			$('#' + input_id).val(val);
			$('#' + input_id).trigger('keyup');
			output = $('#' + test_id).val();
			return output;
		};
				
		var fill_macro_percents = function(fat_pct,carbs_pct,protein_pct) {
			$('#id_goal_meal_fat_percent').val(fat_pct);
			$('#id_goal_meal_carbs_percent').val(carbs_pct);
			$('#id_goal_meal_protein_percent').val(protein_pct);
		};
		
		var check_macro_grams = function(assert_,fat_exp,carbs_exp,protein_exp) {
			fat_grams = $('#id_goal_meal_fat_g').val()
			carbs_grams = $('#id_goal_meal_carbs_g').val()
			protein_grams = $('#id_goal_meal_protein_g').val()
			
			assert_.equal(fat_grams,fat_exp);	
			assert_.equal(carbs_grams,carbs_exp);	
			assert_.equal(protein_grams,protein_exp);	
		};
		
		var fill_macros_with_keyup = function(goal_cals,pct_ids,pct_amts) {
		
			$('#id_goal_meal_cals').val(goal_cals);
			for (i=0; i<pct_ids.length; i++) {	
				$('#' + pct_ids[i]).val(pct_amts[i]);
				$('#' + pct_ids[i]).trigger('keyup');
			}
		};
		
	</script>
</head>
<body>
	<div id="qunit"></div>
	<div id="qunit-fixture">
		<div id='id_meal_maker_side_bar'>
			<div id='id_goal_meal_cals_div'>
				<input id='id_goal_meal_cals' class='goal_cal_inputs' type='text' name='goal_meal_cals' placeholder='cals'/>
				<select id='id_goal_meal_cals_select' class='goal_cal_inputs'>
					<option value="header">Saved Cals</option>
					<option value="602">Meal 1,2,3 - 602 cals</option>
					<option value="305">Meal 4 - 305 cals</option>
				</select>
			</div>
			<div id='id_goal_meal_macros_div'>
				<label for='id_goal_meal_fat_percent'>Percent</label><label for='id_goal_meal_fat_g'>Grams</label><br>
				<label for='id_goal_meal_fat_percent'>Fat</label><input id='id_goal_meal_fat_percent' class='choose_macros' type='text' placeholder='%' data-value="0"/><input id='id_goal_meal_fat_g' class='choose_macros' type='text' placeholder='g'/><br>
				<label for='id_goal_meal_carbs_percent'>Carbs</label><input id='id_goal_meal_carbs_percent' class='choose_macros' type='text' placeholder='%' data-value="0"/><input id='id_goal_meal_carbs_g' class='choose_macros' type='text' placeholder='g'/><br>
				<label for='id_goal_meal_protein_percent'>Protein</label><input id='id_goal_meal_protein_percent' class='choose_macros' type='text' placeholder='%' data-value="0"/><input id='id_goal_meal_protein_g' class='choose_macros' type='text' placeholder='g'/><br>
				<label for='id_goal_meal_macro_percent_total'>% Remaining:</label><span id='id_goal_meal_macro_percent_total'>100</span><br>
			</div>
			<button id='id_create_macro_bars_button' class='btn' disabled>Create Macro Bars</button>
		</div>
		<div id='id_goal_macros_div'>
			<svg id='id_goal_macros_svg'></svg>
		</div>
	</div>
	

	<!--end of test mocks-->
	<!------------------------------------------------------------------------------------------------------------------ -->
	<!------------------------------------------------------------------------------------------------------------------ -->
	<!--QUnit TESTS -->
	<script>
		
		//bar tests
		QUnit.test("calling create macro bars with create macros button creates the macro bars", function (assert) {
			fill_macro_percents('30','40','30');
			$('#id_goal_meal_cals').val('500');
			MM_FUNK.create_macro_button_trigger();
			$('#id_create_macro_bars_button').trigger('click');
			var svg = $('#id_goal_macros_svg'),
			bar_width = (svg.width() - (svg.width() * .1)) / 4.0,
			cal_bar = d3.select('#id_goal_cals_bar'),
			fat_bar = d3.select('#id_goal_fat_bar'),
			carbs_bar = d3.select('#id_goal_carbs_bar'),
			protein_bar = d3.select('#id_goal_protein_bar');

			assert.equal(cal_bar.attr('width'),bar_width);
			assert.equal(fat_bar.attr('width'),bar_width);
			assert.equal(carbs_bar.attr('width'),bar_width);
			assert.equal(protein_bar.attr('width'),bar_width);

			assert.equal(cal_bar.attr('height')/svg.height(),.5);
			assert.equal(fat_bar.attr('height')/cal_bar.attr('height'),.3);
			assert.equal(carbs_bar.attr('height')/cal_bar.attr('height'),.4);
			assert.equal(protein_bar.attr('height')/cal_bar.attr('height'),.3);
		});

		//macro break down % to g tests
		QUnit.test("keystroke in percentage creates grams", function (assert) {
			MM_FUNK.goal_meal_choose_macro_handler();
			
			fat_grams = parseFloat(insert_macro_val_trigger_keyup_return_output(500,'id_goal_meal_fat_percent',34,'id_goal_meal_fat_g'));
			carbs_grams = parseFloat(insert_macro_val_trigger_keyup_return_output(500,'id_goal_meal_carbs_percent',33,'id_goal_meal_carbs_g'));
			protein_grams = parseFloat(insert_macro_val_trigger_keyup_return_output(500,'id_goal_meal_protein_percent',33,'id_goal_meal_protein_g'));

			assert.equal(fat_grams.toFixed(0),19);
			assert.equal(carbs_grams.toFixed(0),41);
			assert.equal(protein_grams.toFixed(0),41);
		});
		QUnit.test("keystroke in protein grams creates % in protein %", function (assert) {
			MM_FUNK.goal_meal_choose_macro_handler();
			
			fat_pct = parseFloat(insert_macro_val_trigger_keyup_return_output(500,'id_goal_meal_fat_g',19,'id_goal_meal_fat_percent'));
			carbs_pct = parseFloat(insert_macro_val_trigger_keyup_return_output(500,'id_goal_meal_carbs_g',41,'id_goal_meal_carbs_percent'));
			protein_pct = parseFloat(insert_macro_val_trigger_keyup_return_output(500,'id_goal_meal_protein_g',41,'id_goal_meal_protein_percent'));

			assert.equal(fat_pct.toFixed(0),34);
			assert.equal(carbs_pct.toFixed(0),33);
			assert.equal(protein_pct.toFixed(0),33);
		});
		QUnit.test("choose_macro_handler can handle deletes", function (assert) {
			MM_FUNK.goal_meal_choose_macro_handler();
			fat_pct = insert_macro_val_trigger_keyup_return_output(500,'id_goal_meal_fat_g','','id_goal_meal_fat_percent');
			assert.equal(fat_pct,'');
		});
		//macro totaller
		QUnit.test("macro_percent_totaler tallys the macro percent total correctly", function (assert) {
			MM_FUNK.goal_meal_choose_macro_handler();
			insert_macro_val_trigger_keyup_return_output(500,'id_goal_meal_fat_percent',40,'id_goal_meal_fat_g');
			insert_macro_val_trigger_keyup_return_output(500,'id_goal_meal_carbs_percent',33,'id_goal_meal_carbs_g');
			percent_total = $('#id_goal_meal_macro_percent_total').html();
			assert.equal(percent_total,'27');
		});
		QUnit.test("macro_percent_totaler doesn't break upon delete", function (assert) {
			MM_FUNK.goal_meal_choose_macro_handler();
			insert_macro_val_trigger_keyup_return_output(500,'id_goal_meal_fat_percent',40,'id_goal_meal_fat_g');
			insert_macro_val_trigger_keyup_return_output(500,'id_goal_meal_fat_percent','','id_goal_meal_fat_g');
			percent_total = $('#id_goal_meal_macro_percent_total').html();
			assert.equal(percent_total,'100');
		});

		//set initial macros
		QUnit.test("set initial macro pcts totals correctly upon page load if there are preloaded amts", function (assert) {
			fill_macro_percents('30','40','30');
			MM_FUNK.set_initial_macro_percent_tally();
			percent_total = $('#id_goal_meal_macro_percent_total').html();
			assert.equal(percent_total,'0');
		});
		QUnit.test("set initial macro pcts totals correctly upon page load if there aren't preloaded amts", function (assert) {
			MM_FUNK.set_initial_macro_percent_tally();
			percent_total = $('#id_goal_meal_macro_percent_total').html();
			assert.equal(percent_total,'100');
		});
		//enableing disabling create macro bars button
		
		QUnit.test("create button not enabled when total pct == 0 and CAL_GOAL == 0", function (assert) {
			MM_FUNK.CAL_GOAL = 0;
			MM_FUNK.goal_cal_inputs_trigger();
			MM_FUNK.goal_meal_choose_macro_handler();
			fill_macros_with_keyup(500,['id_goal_meal_fat_percent','id_goal_meal_carbs_percent','id_goal_meal_protein_percent'],[40,30,30]);
			is_button_disabled = $('#id_create_macro_bars_button').is(':disabled');
			assert.equal(is_button_disabled,true);
		});
		QUnit.test("macro_percent_totaler not enabled create button when total pct != 0 and CAL_GOAL != 0", function (assert) {
			MM_FUNK.CAL_GOAL = 0;
			MM_FUNK.goal_cal_inputs_trigger();
			MM_FUNK.goal_meal_choose_macro_handler();
			fill_macros_with_keyup(500,['id_goal_meal_fat_percent','id_goal_meal_carbs_percent','id_goal_meal_protein_percent'],[10,10,10]);
			$('#id_goal_meal_cals').trigger('keyup');
			is_button_disabled = $('#id_create_macro_bars_button').is(':disabled');
			assert.equal(is_button_disabled,true);
		});
		
		QUnit.test("macro_percent_totaler does enables create button when total pct == 0 and CAL_GOAL != 0", function (assert) {
			MM_FUNK.CAL_GOAL = 0;
			MM_FUNK.goal_cal_inputs_trigger();
			MM_FUNK.goal_meal_choose_macro_handler();
			fill_macros_with_keyup(500,['id_goal_meal_fat_percent','id_goal_meal_carbs_percent','id_goal_meal_protein_percent'],[40,30,30]);
			$('#id_goal_meal_cals').trigger('keyup');
			is_button_disabled = $('#id_create_macro_bars_button').is(':disabled');
			assert.equal(is_button_disabled,false);
		});
		//macros breakdown table and goal cals selection
		QUnit.test('meal cal selection fills in breakdown table grams',function (assert) {
			MM_FUNK.goal_cal_inputs_trigger();
			fill_macro_percents('34','33','33');
			$('#id_goal_meal_cals_select').val('305').trigger('change');
			$('#id_goal_meal_cals_select>option:eq(1)').prop('selected',true);
			check_macro_grams(assert,'12','25','25');
		});		
		
		QUnit.test('meal cal input fills in breakdown table grams',function (assert) {
			MM_FUNK.goal_cal_inputs_trigger();
			fill_macro_percents('34','33','33');
			$('#id_goal_meal_cals').val('500');
			$('#id_goal_meal_cals').trigger('keyup');
			
			check_macro_grams(assert,'19','41','41');
		});		
		
		QUnit.test('meal cal selection clears meal cal input',function (assert) {
			MM_FUNK.goal_cal_inputs_trigger();
			$('#id_goal_meal_cals').val('500');
			$('#id_goal_meal_cals_select').val('305').trigger('change');
			$('#id_goal_meal_cals_select>option:eq(1)').prop('selected',true);
			cals_input = $('#id_goal_meal_cals').val();
			assert.equal(cals_input,'');
		});		

		QUnit.test('meal cal selection fills in grams and subsequent change of percentage changes grams',function (assert) {
			MM_FUNK.goal_cal_inputs_trigger();
			MM_FUNK.goal_meal_choose_macro_handler();
			fill_macro_percents('34','33','33');
			$('#id_goal_meal_cals_select>option:eq(2)').prop('selected',true);
			$('#id_goal_meal_fat_percent').val('30');
			$('#id_goal_meal_fat_percent').trigger('keyup');
			
			new_fat =  $('#id_goal_meal_fat_g').val();
			assert.equal(new_fat,'10');
		});		
			
		QUnit.test('meal cal input sets dropdown to header',function (assert) {
			MM_FUNK.goal_cal_inputs_trigger();
			$('#id_goal_meal_cals').val('500');
			select_val = $('#id_goal_meal_cals_select option:selected').val();
			assert.equal(select_val,'header');
		});
		QUnit.test('meal cal input sets CAL_GOAL',function (assert) {
			MM_FUNK.CAL_GOAL = 0;
			MM_FUNK.goal_cal_inputs_trigger();
			$('#id_goal_meal_cals').val('500');
			$('#id_goal_meal_cals').trigger('keyup');
			assert.equal(MM_FUNK.CAL_GOAL,500);
		});
		QUnit.test('meal cal dropdown sets CAL_GOAL',function (assert) {
			MM_FUNK.CAL_GOAL = 0;
			MM_FUNK.goal_cal_inputs_trigger();
			$('#id_goal_meal_cals_select').val('305').trigger('change');
			assert.equal(MM_FUNK.CAL_GOAL,305);
		});
		
	</script>
</body>
</html>

